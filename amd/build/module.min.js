define(["jquery","core/ajax","core/custom_interaction_events","core/notification","core/modal_events","core/modal_factory"],function(a,b,c,d,e,f){return{init:function(b){var c=this;a("#inst"+b+" .footer a").on("click",function(d){d.preventDefault(),d.stopPropagation();var e=a(this);e.removeAttr("href"),c.refresh(b),e.attr("href","#")});var d=a("#inst"+b+"-content");return"1"==d.data("refresh")?(d.data("refresh","0"),void c.refresh(b)):(c.initcorb(b),c.initajax(b),void c.initpaging(b))},initcorb:function(b){a("#inst"+b+'-content div[data-toggle="btns"]').each(function(){var b=this;c.define(b,[c.events.activate]),a(this).on(c.events.activate,"a.btn",function(){a(b).find("a.btn.active").removeClass("active")})})},initajax:function(c){var g=this,h="#inst"+c+'-content .status-container button[data-action!="restore"]';a(h).off("click").on("click",function(e){e.preventDefault(),e.stopPropagation();var f=a(this),h=f.closest(".status-wrapper");f.attr("disabled","1"),h.fadeTo("fast",.05,function(){b.call([{methodname:"block_mysites_sendrequestaction",args:{blockinstanceid:c,action:f.data("action"),siteid:f.data("siteid"),courseid:f.data("courseid")}}]).shift().done(function(a){h.html(a),g.initajax(c),h.fadeTo("slow",1)}).fail(d.exception)})}),h="#inst"+c+'-content .status-container button[data-action="restore"]',a(h).off("click").on("click",function(g){g.preventDefault(),g.stopPropagation();var h=a(this);b.call([{methodname:"block_mysites_getcourseselect",args:{blockinstanceid:c}}]).shift().done(function(b){f.create({type:f.types.SAVE_CANCEL,title:"Restore archive",body:b},h).done(function(b){var c=a(b.getRoot()),d=c.find('button[data-action="save"]');d.text("OK"),d.attr("disabled","1");var f=c.find('input[name="filename"]');f.val(h.data("filename")),c.on(e.save,function(b){b.preventDefault(),a(c.find('form[name="form"]')).submit()}),c.find("#contextid").change(function(){""==this.value?d.attr("disabled","1"):d.removeAttr("disabled")}),b.show()})}).fail(d.exception)})},initpaging:function(b){a("#inst"+b+'-content nav[data-region="page-bar"]').each(function(){c.define(this,[c.events.activate]),a(this).on(c.events.activate,"a.page-link",function(b,c){c.originalEvent.preventDefault();var d=a(b.delegateTarget),e=d.data("pageNumber"),f=a(this.parentNode).data("pageNumber");"first"==f?f="1":"last"==f&&(f=d.data("pageCount")),e!=f&&(d.data("pageNumber",f),d.find("li").each(function(){a(this).removeClass("active")}),d.find('li[data-page-number="'+f+'"]').addClass("active"),a(d.parent().parent().find('div[data-page="'+e+'"]')).addClass("hidden"),a(d.parent().parent().find('div[data-page="'+f+'"]')).removeClass("hidden"))})})},refresh:function(c){var e=this,f=a("#inst"+c+"-content");if(f.length){var g=a("#inst"+c+"-tablist li.nav-item a.nav-link.active").data("siteIndex");"undefined"==typeof g&&(g=1);var h=a("#inst"+c+"-tab-"+g+" .btn-group a.btn.active").data("corbIndex");"undefined"==typeof h&&(h=1);var i="#inst"+c+"-tab-"+g+(2==h?"-backups":"-courses")+" nav",j=a(i).data("pageNumber");"undefined"==typeof j&&(j=1);var k=f.parent();a.when(k.fadeTo("fast",.05)).done(function(){b.call([{methodname:"block_mysites_getcontenttext",args:{blockinstanceid:c,siteindex:g,corbindex:h,pageindex:j}}]).shift().done(function(a){f.replaceWith(a),e.initcorb(c),e.initajax(c),e.initpaging(c),k.fadeTo("slow",1)}).fail(d.exception)})}}}});